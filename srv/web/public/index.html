<html>
    <title>nodezoo</title>
    <style>
    </style>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <div id="app">
            <h1>NodeZoo</h1>        
            <input
                v-model="q"
                v-on:keyup.enter="showQuery(q)"
            />
            
            <div  v-if="show.search">
                <ul>
                    <li
                        v-for="item in res"
                        :key="item.id"
                        @click="showInfo(item,false)"
                    >
                        <h3>{{ item.name }} &#9734; {{ item.stars }}</h3>
                        <p>
                            {{ item.desc }}
                        </p>
                    </li>
                </ul>

                <p v-if="none">No modules found.</p>
            </div>

            <div v-if="show.info">
                <h2>{{ item.name }}</h2>
                <p v-if="none && !pending">Not found.</p>
                <p v-if="!none && pending">Loading...</p>
                <p v-if="!pending && !none">
                    <p>
                        {{ item.desc }}
                    </p>
                    <p v-if="item.giturl"> 
                        Github: <a :href="giturl(item)">{{ gitnice(item) }}</a> 
                    </p>
                    <p>
                        Last Update: {{ item.last }}<br />
                        Stars: {{ item.stars }}<br />
                        Forks: {{ item.forks }}<br />
                        Watches: {{ item.watches }}<br />
                    </p>

                </p>
            </div>
        </div>

        <script>
         window.app = new Vue({
             el: '#app',
             data: {
                 q: '',
                 res: [],
                 none: false,
                 pending: false,
                 show: {
                     search: true,
                     info: false,
                 },
                 item: {},
                 hash: '',
             },
             created () {
                 let qv = this.q
                 setInterval(()=>{
                     if(qv != this.q) {
                         qv = this.q
                         this.query(this.q)
                     }
                 },333)
                 if(window.location.hash) {
                     this.hashAction()
                 }
             },
             watch: {
                 q () {
                     this.none = false
                     this.pending = false
                     this.show.search = true
                     this.show.info = false
                 }
             },
             methods: {
                 query (q) {
                     if( '' != q) {
                         this.none = false
                         fetch('https://api.nodezoo.com/api/query/'+encodeURIComponent(q))
                             .then(response => response.json())
                             .then(out => {
                                 if(out.ok) {
                                     this.res = out.res.map(item=>{
                                         let out = {}
                                         Object.entries(item.fields).forEach(([f,v])=>out[f]=v[0])
                                         return out
                                     })
                                     this.none = 0 === this.res.length
                                     this.hashAction('search/'+encodeURIComponent(q))
                                 }
                                 else {
                                     this.none = true
                                 }
                             })
                     }
                 },

                 showQuery(q) {
                     this.none = false
                     this.pending = false
                     this.show.search = true
                     this.show.info = false
                     this.query(q)
                 },

                 showInfo(item,pending) {
                     this.none = false
                     this.pending = pending
                     this.item = item
                     this.show.search = false
                     this.show.info = true
                     this.hashAction('info/'+encodeURIComponent(item.name))
                 },

                 loadInfo(name) {
                     fetch('https://api.nodezoo.com/api/info/'+encodeURIComponent(name))
                         .then(response => response.json())
                         .then(out => {
                             if(out.ok) {
                                 if(out.pending) {
                                     this.pending = true
                                     setTimeout(()=>this.loadInfo(name),777)
                                 }
                                 else {
                                     this.item = { ...out.info.npm, ...out.info.github }
                                     this.none = false
                                     this.pending = false
                                 }
                             }
                             else {
                                 this.pending = false
                                 this.none = true
                             }
                         })
                 },

                 hashAction (hash) {
                     if(hash) {
                         this.hash = window.location.hash = hash
                     }
                     else if(this.hash != window.location.hash) {
                         this.hash = window.location.hash
                         let parts = window.location.hash.slice(1).split('/')
                         if('search' === parts[0]) {
                             this.q = parts[1]
                         }
                         else if('info' === parts[0]) {
                             this.pending = true
                             this.showInfo({name:parts[1]},true)
                             this.loadInfo(parts[1])
                         }
                     }
                 },

                 giturl (item) {
                     return (item.giturl||'').slice(4)
                 },

                 gitnice (item) {
                     return (item.giturl||'').slice(23).replace(/\.git$/,'')
                 },

             }
         })
        </script>
    </body>
</html>
